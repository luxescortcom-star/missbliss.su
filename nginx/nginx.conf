
events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    server {
        listen 80;
        server_name localhost;
        root /var/www/html;
        index index.php index.html index.htm;
        
        absolute_redirect off;
        port_in_redirect off;

		
		  location = /vip-models/ {
			return 301 /vip-models/all_vip_escorts/;
        }
		  location = /elite-models/ {
			return 301 /elite-models/all_vip_escorts/;
        }
		  location = /all_vip_escorts/ {
			return 301 /vip-models/all_vip_escorts/;
        }
		 location  /xxx/ {
			rewrite ^/xxx/(.*)$ /vip-models/$1 permanent;
        }
		location /en/xxx/ {
			rewrite ^/en/xxx/(.*)$ /elite-models/$1 permanent;
        }
	

	   rewrite ^(.*)/rostov-on-don/$ $1/rostov-on-don/favorites/camilla/ permanent;
	   rewrite ^/(.*)?/?rnd/?$ $1/rostov-on-don/favorites/camilla/ permanent;
	   rewrite ^(.*)/escorts/$ $1/all_vip_escorts/ permanent;
	   rewrite ^(.*)/spb/(.*[^\.css])$ $1/saint-petersburg/$2 permanent;
	   rewrite ^(.*)/ekb/(.*)$ $1/ekatersburg/$2 permanent;
	   rewrite ^(.*)/nyc/(.*)$ $1/new-york/favorites/natasha/ permanent;
		
		   # --- 1. ПЕРЕХВАТ 404 ОШИБКИ ---
    # Когда возникает 404, Nginx делает внутренний запрос к @fallback
	fastcgi_intercept_errors on;
    error_page 404 = @fallback;

    # --- 1. ВАШ НОВЫЙ ОБРАБОТЧИК (редиректы по sitemap) ---
    location @fallback {
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root/redirecthandler.php; 
        fastcgi_param REQUEST_URI $request_uri;
        # Здесь перехват ошибок выключаем, чтобы не зациклиться
        fastcgi_intercept_errors off; 
    }

        set $htpasswd_path /var/www/html/zero/ladies_pass/.htpasswd;
		
     # --- ГЛОБАЛЬНЫЙ БЛОК ОБРАБОТКИ PHP ДЛЯ ПРЯМЫХ ЗАПРОСОВ К ФАЙЛАМ (.php) ---
        # Этот блок работает для всего сайта, включая защищенные папки.
        location ~ \.php$ {
            try_files $uri =404;
            fastcgi_pass php:9000;
            fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
            fastcgi_param PHP_VALUE "display_errors=0\nerror_reporting=22527";
            include fastcgi_params;
			fastcgi_intercept_errors on;
        }

        # --- ЗАЩИТА ПАПКИ /vip-models/ (ЧИСТЫЕ URL РАБОТАЮТ ЗДЕСЬ) ---
        location /vip-models/ {
            auth_basic "Secret Models Area";
            auth_basic_user_file $htpasswd_path; 
            error_page 401 403 /access/;

            # Поиск: 1. Файл 2. Директория (index.php) 
            # Если не найдено, передаем в @auth_handler_php
            try_files $uri $uri/ @auth_handler_php; 
        }

        # --- ЗАЩИТА ПАПКИ /elite-models/ (ЧИСТЫЕ URL РАБОТАЮТ ЗДЕСЬ) ---
        location /elite-models/ {
            auth_basic "Secret Models Area";
            auth_basic_user_file $htpasswd_path; 
            error_page 401 403 /en/access/;
            
            try_files $uri $uri/ @auth_handler_php;
        }
        
        # --- ОБРАБОТЧИК PHP ДЛЯ ЗАЩИЩЕННЫХ ПАПОК (ИМЕНОВАННЫЙ) ---
        # Сюда попадут запросы Clean URL без расширения (например, /vip-models/moscow/)
        location @auth_handler_php {
            # Мы ожидаем, что URI оканчивается на слэш, удаляем его и добавляем .php
            # /elite-models/moscow/ -> /elite-models/moscow.php
            rewrite ^/(.*)/$ /$1.php break; 

            fastcgi_param SCRIPT_FILENAME $document_root$uri;
            fastcgi_pass php:9000;
            fastcgi_param PHP_VALUE "display_errors=0\nerror_reporting=22527"; 
            include fastcgi_params;
			fastcgi_intercept_errors on;
        }
        
        # --- 1. Статические файлы ---
        location ~* \.(css|js|json|jpg|png|gif|ico|svg|otf|ttf|woff|woff2)$ {
            expires 30d;
            try_files $uri =404;
        }
		
				# Виртуальный путь для рандомной картинки
    location = /social/agency/random_wall.avif {
    # Указываем кэширование на уровне Nginx на 1 час
    add_header Cache-Control "public, max-age=3600";
    
    # Передаем запрос на PHP-рандомайзер
    include fastcgi_params;
    fastcgi_pass php:9000;
    fastcgi_param SCRIPT_FILENAME $document_root/random-wall.php;
}

        # --- 2. Основной блок обработки URL (Clean URLs ДЛЯ ОСНОВНОГО САЙТА) ---
        location / {
            try_files $uri.html $uri.php $uri/ @php_handler;
        }

        # --- 3. Обработчик PHP для "чистых" URL (без расширения) ---
        location @php_handler {
        # Ваша логика обрезки слэша
        if ($uri ~ ^/(.*)/$) { set $clean_uri /$1; }
        if ($uri !~ ^/(.*)/$) { set $clean_uri $uri; }
        
        fastcgi_pass php:9000;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$clean_uri.php;
        fastcgi_param PHP_VALUE "display_errors=0\nerror_reporting=22527";
        
        # Обязательно включаем перехват здесь!
        fastcgi_intercept_errors on;
    }

        # --- 4. Редиректы (SEO/Clean URL Enforcement ДЛЯ ОСНОВНОГО САЙТА) ---
        if ($request_uri ~* ^(.*)\.(html|php)(\?.*)?$) {
            return 301 $1$3;
        }
        
        if ($uri !~ "\.") {
            rewrite ^(.*[^/])$ $1/ permanent;
        }

    }
}
